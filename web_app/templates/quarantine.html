{% extends "base.html" %} {% block title %}Quarentena - MediocreToons Auto
Uploader v2{% endblock %} {% block content %}
<!-- Header com ações -->
<div class="app-header fade-in">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1><i class="fas fa-ban"></i> Sistema de Quarentena</h1>
      <p class="subtitle">Gerenciamento automático de obras com problemas</p>
    </div>
    <div>
      <form
        method="POST"
        action="{{ url_for('quarantine_check') }}"
        class="d-inline"
      >
        <button
          type="submit"
          class="btn btn-outline-primary"
          data-confirm="Executar verificação automática de quarentena?"
        >
          <i class="fas fa-search"></i> Verificar Quarentena
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Estatísticas de Quarentena -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-warning text-dark">
      <div class="card-body text-center">
        <div class="h2 mb-0" data-stat="total_quarantined">
          {{ quarantine_stats.total_quarantined }}
        </div>
        <div class="small">Obras em Quarentena</div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-info text-white">
      <div class="card-body text-center">
        <div class="h2 mb-0" data-stat="auto_quarantines_today">
          {{ quarantine_stats.auto_quarantines_today }}
        </div>
        <div class="small">Quarentenas Hoje</div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-success text-white">
      <div class="card-body text-center">
        <div class="h2 mb-0" data-stat="manual_restores_today">
          {{ quarantine_stats.manual_restores_today }}
        </div>
        <div class="small">Restaurações Hoje</div>
      </div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6 mb-3">
    <div class="card bg-secondary text-white">
      <div class="card-body text-center">
        <div class="h2 mb-0">
          {{ quarantine_stats.quarantined_by_scan|length }}
        </div>
        <div class="small">Scans Afetados</div>
      </div>
    </div>
  </div>
</div>

<!-- Obras em Quarentena -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-list"></i> Obras em Quarentena
          <span class="badge bg-warning ms-2"
            >{{ quarantined_obras|length }}</span
          >
        </h5>
      </div>
      <div class="card-body">
        {% if quarantined_obras %}
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Título</th>
                <th>Scan</th>
                <th>Erros</th>
                <th>Último Upload</th>
                <th>Atualização</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for obra in quarantined_obras %}
              <tr>
                <td>
                  <code>{{ obra.obra_id }}</code>
                </td>
                <td>
                  <strong>{{ obra.titulo }}</strong>
                  {% if obra.url_relativa %}
                  <br />
                  <small class="text-muted">
                    <a
                      href="{{ obra.url_relativa }}"
                      target="_blank"
                      class="text-decoration-none"
                    >
                      <i class="fas fa-external-link-alt"></i>
                    </a>
                  </small>
                  {% endif %}
                </td>
                <td>
                  <span class="badge bg-secondary">{{ obra.scan_name }}</span>
                </td>
                <td>
                  <span class="error-count">{{ obra.erros_consecutivos }}</span>
                </td>
                <td>
                  {% if obra.ultimo_upload %}
                  <small>{{ obra.ultimo_upload[:10] }}</small>
                  {% else %}
                  <span class="text-muted">Nunca</span>
                  {% endif %}
                </td>
                <td>
                  {% if obra.updated_at %}
                  <small>{{ obra.updated_at[:16] }}</small>
                  {% else %}
                  <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  <form
                    method="POST"
                    action="{{ url_for('quarantine_restore', scan_name=obra.scan_name, obra_id=obra.obra_id) }}"
                    class="d-inline"
                  >
                    <input type="hidden" name="user" value="web-interface" />
                    <button
                      type="submit"
                      class="btn btn-sm btn-success"
                      data-confirm="Remover '{{ obra.titulo }}' da quarentena e resetar contador de erros?"
                      title="Remover da Quarentena"
                    >
                      <i class="fas fa-undo"></i> Restaurar
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-4">
          <i
            class="fas fa-check-circle text-success"
            style="font-size: 3em"
          ></i>
          <h5 class="mt-3">Nenhuma Obra em Quarentena</h5>
          <p class="text-muted">
            Todas as obras estão funcionando corretamente!
          </p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Distribuição por Scan -->
{% if quarantine_stats.quarantined_by_scan %}
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fas fa-chart-pie"></i> Distribuição por Scan
        </h6>
      </div>
      <div class="card-body">
        <div class="row">
          {% for scan_name, count in
          quarantine_stats.quarantined_by_scan.items() %}
          <div class="col-lg-3 col-md-4 col-sm-6 mb-2">
            <div
              class="d-flex justify-content-between align-items-center bg-light p-2 rounded"
            >
              <span class="small">{{ scan_name }}</span>
              <span class="badge bg-warning">{{ count }}</span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Histórico Recente -->
{% if quarantine_history %}
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h6 class="mb-0"><i class="fas fa-history"></i> Histórico Recente</h6>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Data/Hora</th>
                <th>Ação</th>
                <th>Obra</th>
                <th>Scan</th>
                <th>Erros</th>
                <th>Usuário</th>
                <th>Motivo</th>
              </tr>
            </thead>
            <tbody>
              {% for event in quarantine_history[:20] %}
              <tr>
                <td><small>{{ event.timestamp[:16] }}</small></td>
                <td>
                  {% if event.action == 'quarantined' %}
                  <span class="badge bg-warning text-dark">Quarentena</span>
                  {% elif event.action == 'manual_restore' %}
                  <span class="badge bg-success">Restaurado</span>
                  {% else %}
                  <span class="badge bg-secondary">{{ event.action }}</span>
                  {% endif %}
                </td>
                <td><code>{{ event.obra_id }}</code></td>
                <td><small>{{ event.scan_name }}</small></td>
                <td>
                  {% if event.error_count > 0 %}
                  <span class="error-count">{{ event.error_count }}</span>
                  {% else %}
                  <span class="badge bg-success">0</span>
                  {% endif %}
                </td>
                <td><small>{{ event.user or 'sistema' }}</small></td>
                <td><small>{{ event.reason or '-' }}</small></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %} {% endblock %} {% block scripts %}
<script>
  // Refresh automático específico da página de quarentena
  setInterval(() => {
    // Recarregar página se houver mudanças significativas
    fetch("/api/quarantine/stats")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          const currentCount = parseInt(
            document.querySelector('[data-stat="total_quarantined"]')
              .textContent
          );
          if (currentCount !== data.data.total_quarantined) {
            // Houve mudança no número de quarentenas, recarregar página
            location.reload();
          }
        }
      });
  }, 60000); // Verificar a cada 1 minuto
</script>
{% endblock %}

{% extends "base.html" %} 
{% block title %}Health Check Dashboard{% endblock %}
{% block extra_css %}
<style>
  /* Health cards usando sistema de design */
  .health-card {
    border-left: 4px solid var(--color-gray-300);
    transition: all var(--transition-normal);
    background: var(--color-white);
    border-radius: var(--border-radius-lg);
    padding: var(--space-4);
    box-shadow: var(--shadow);
  }

  .health-card.online {
    border-left-color: var(--color-success);
  }

  .health-card.degraded {
    border-left-color: var(--color-warning);
  }

  .health-card.offline {
    border-left-color: var(--color-danger);
  }

  .health-card.unknown {
    border-left-color: var(--color-gray-500);
  }

  /* Indicadores de status usando variáveis CSS */
  .status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: var(--space-2);
  }

  .status-online { background-color: var(--color-success); }
  .status-degraded { background-color: var(--color-warning); }
  .status-offline { background-color: var(--color-danger); }
  .status-unknown { background-color: var(--color-gray-500); }

  /* Metric cards usando paleta primária */
  .metric-card {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
    color: var(--color-white);
    border-radius: var(--border-radius-lg);
    padding: var(--space-5);
    margin-bottom: var(--space-5);
    box-shadow: var(--shadow-primary);
  }

  .refresh-btn.spinning {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  .chart-container {
    position: relative;
    height: 300px;
    margin: var(--space-5) 0;
  }

  .response-time-chart {
    max-height: 200px;
  }
</style>
{% endblock %} {% block content %}
<!-- Header do Health Dashboard -->
<div class="app-header fade-in">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1><i class="fas fa-heartbeat"></i> Health Check Dashboard</h1>
      <p class="subtitle">Monitoramento de saúde das APIs</p>
    </div>
    <div class="action-buttons">
      <button id="refreshBtn" class="btn btn-primary">
        <i class="fas fa-sync-alt"></i> Atualizar
      </button>
      <a href="{{ url_for('health.config_page') }}" class="btn btn-outline-primary">
        <i class="fas fa-cog"></i> Configurar
      </a>
    </div>
  </div>
</div>

  <!-- Métricas Gerais usando grid system -->
  <div class="health-status-grid fade-in" id="overallMetrics">
    <div class="metric-card text-center">
      <h3 id="totalProviders">-</h3>
      <p class="mb-0">Total de Providers</p>
    </div>
    <div class="metric-card text-center">
      <h3 id="onlineProviders">-</h3>
      <p class="mb-0">Online</p>
    </div>
    <div class="metric-card text-center">
      <h3 id="uptimePercentage">-</h3>
      <p class="mb-0">Uptime Médio</p>
    </div>
    <div class="metric-card text-center">
      <h3 id="avgResponseTime">-</h3>
      <p class="mb-0">Tempo Médio</p>
    </div>
  </div>

  <!-- Status das APIs -->
  <div class="card slide-up">
    <div class="card-header">
      <h5 class="card-title">
        <i class="fas fa-server"></i> Status dos Providers
        <small class="text-muted" id="lastUpdate">Carregando...</small>
      </h5>
    </div>
    <div class="card-body">
      <div id="providersContainer">
        <div class="text-center p-5">
          <div class="spinner text-primary"></div>
          <p class="mt-3">Carregando dados de saúde...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Gráfico de Status -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="fas fa-chart-line"></i> Histórico de Status
          </h5>
        </div>
        <div class="card-body">
          <div class="chart-container">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal fade" id="detailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Detalhes da API</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body" id="modalBody">
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="mt-2">Carregando detalhes...</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  class HealthDashboard {
    constructor() {
      this.providers = [];
      this.statusChart = null;
      this.refreshInterval = null;
      this.init();
    }

    init() {
      this.setupEventListeners();
      this.loadData();
      this.startAutoRefresh();
    }

    setupEventListeners() {
      document.getElementById("refreshBtn").addEventListener("click", () => {
        this.loadData();
      });
    }

    async loadData() {
      const refreshBtn = document.getElementById("refreshBtn");
      const refreshIcon = refreshBtn.querySelector("i");

      try {
        refreshIcon.classList.add("refresh-btn");

        const response = await fetch("/health/api/status");
        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        this.providers = data.providers;
        this.updateOverallMetrics();
        this.updateProvidersDisplay();
        this.updateLastUpdateTime(data.last_updated);
      } catch (error) {
        console.error("Erro ao carregar dados:", error);
        this.showError("Erro ao carregar dados de saúde");
      } finally {
        refreshIcon.classList.remove("refresh-btn");
      }
    }

    updateOverallMetrics() {
      const total = this.providers.length;
      const online = this.providers.filter(
        (p) => p.current_status === "online"
      ).length;
      const uptimes = this.providers
        .map((p) => p.uptime_percentage_24h)
        .filter((u) => u > 0);
      const avgUptime =
        uptimes.length > 0
          ? uptimes.reduce((a, b) => a + b, 0) / uptimes.length
          : 0;
      const responseTimes = this.providers
        .map((p) => p.response_time_ms)
        .filter((r) => r !== null);
      const avgResponseTime =
        responseTimes.length > 0
          ? responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length
          : 0;

      document.getElementById("totalProviders").textContent = total;
      document.getElementById("onlineProviders").textContent = online;
      document.getElementById("uptimePercentage").textContent =
        avgUptime.toFixed(1) + "%";
      document.getElementById("avgResponseTime").textContent =
        avgResponseTime.toFixed(0) + "ms";
    }

    updateProvidersDisplay() {
      const container = document.getElementById("providersContainer");

      if (this.providers.length === 0) {
        container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h5>Nenhum provider configurado</h5>
                    <p class="text-muted">Configure providers na página de configurações</p>
                </div>
            `;
        return;
      }

      const html = this.providers
        .map(
          (provider) => `
            <div class="card health-card ${provider.current_status} mb-3">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h6 class="mb-1">
                                <span class="status-indicator status-${
                                  provider.current_status
                                }"></span>
                                ${provider.name}
                            </h6>
                            <small class="text-muted">${provider.url}</small>
                        </div>
                        <div class="col-md-2 text-center">
                            <span class="badge ${this.getStatusBadgeClass(
                              provider.current_status
                            )}">
                                ${provider.current_status.toUpperCase()}
                            </span>
                        </div>
                        <div class="col-md-2 text-center">
                            <strong>${
                              provider.response_time_ms
                                ? provider.response_time_ms.toFixed(0) + "ms"
                                : "N/A"
                            }</strong>
                            <br><small class="text-muted">Resposta</small>
                        </div>
                        <div class="col-md-2 text-center">
                            <strong>${provider.uptime_percentage_24h.toFixed(
                              1
                            )}%</strong>
                            <br><small class="text-muted">Uptime 24h</small>
                        </div>
                        <div class="col-md-2 text-end">
                            <button class="btn btn-outline-primary btn-sm" onclick="dashboard.showDetails('${
                              provider.url
                            }')">
                                <i class="fas fa-info-circle"></i> Detalhes
                            </button>
                        </div>
                    </div>
                    ${
                      provider.consecutive_failures > 0
                        ? `
                        <div class="row mt-2">
                            <div class="col-12">
                                <div class="alert alert-warning alert-sm mb-0">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    ${provider.consecutive_failures} falhas consecutivas
                                </div>
                            </div>
                        </div>
                    `
                        : ""
                    }
                </div>
            </div>
        `
        )
        .join("");

      container.innerHTML = html;
    }

    getStatusBadgeClass(status) {
      const classes = {
        online: "bg-success",
        degraded: "bg-warning",
        offline: "bg-danger",
        unknown: "bg-secondary",
      };
      return classes[status] || "bg-secondary";
    }

    async showDetails(url) {
      const modal = new bootstrap.Modal(
        document.getElementById("detailsModal")
      );
      const modalBody = document.getElementById("modalBody");

      modalBody.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Carregando detalhes...</p>
            </div>
        `;

      modal.show();

      try {
        const encodedUrl = encodeURIComponent(url);
        const response = await fetch(`/health/api/metrics/${encodedUrl}`);
        const data = await response.json();

        if (data.error) {
          throw new Error(data.error);
        }

        modalBody.innerHTML = this.generateDetailsHTML(data);
      } catch (error) {
        console.error("Erro ao carregar detalhes:", error);
        modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Erro ao carregar detalhes: ${error.message}
                </div>
            `;
      }
    }

    generateDetailsHTML(data) {
      return `
            <div class="row">
                <div class="col-12 mb-3">
                    <h6><i class="fas fa-globe"></i> ${data.url}</h6>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h5>${data.metrics.total_checks}</h5>
                            <p class="mb-0">Total de Verificações</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h5>${data.metrics.failure_rate.toFixed(1)}%</h5>
                            <p class="mb-0">Taxa de Falha</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <h6>Uptime 24h</h6>
                    <div class="progress mb-2">
                        <div class="progress-bar ${
                          data.uptime_24h.uptime_percentage >= 95
                            ? "bg-success"
                            : data.uptime_24h.uptime_percentage >= 90
                            ? "bg-warning"
                            : "bg-danger"
                        }" 
                             style="width: ${
                               data.uptime_24h.uptime_percentage
                             }%"></div>
                    </div>
                    <small class="text-muted">${data.uptime_24h.uptime_percentage.toFixed(
                      2
                    )}% (${data.uptime_24h.online_checks}/${
        data.uptime_24h.total_checks
      } verificações)</small>
                </div>
                <div class="col-md-6">
                    <h6>Uptime 7 dias</h6>
                    <div class="progress mb-2">
                        <div class="progress-bar ${
                          data.uptime_7d.uptime_percentage >= 95
                            ? "bg-success"
                            : data.uptime_7d.uptime_percentage >= 90
                            ? "bg-warning"
                            : "bg-danger"
                        }" 
                             style="width: ${
                               data.uptime_7d.uptime_percentage
                             }%"></div>
                    </div>
                    <small class="text-muted">${data.uptime_7d.uptime_percentage.toFixed(
                      2
                    )}% (${data.uptime_7d.online_checks}/${
        data.uptime_7d.total_checks
      } verificações)</small>
                </div>
            </div>
            
            <div class="mb-4">
                <h6>Histórico Recente</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Horário</th>
                                <th>Status</th>
                                <th>Tempo</th>
                                <th>Erro</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.recent_history
                              .slice(0, 10)
                              .map(
                                (h) => `
                                <tr>
                                    <td>${this.formatTimestamp(
                                      h.timestamp
                                    )}</td>
                                    <td><span class="badge ${this.getStatusBadgeClass(
                                      h.status
                                    )}">${h.status.toUpperCase()}</span></td>
                                    <td>${
                                      h.response_time_ms
                                        ? h.response_time_ms.toFixed(0) + "ms"
                                        : "N/A"
                                    }</td>
                                    <td>${
                                      h.error_message
                                        ? h.error_message.substring(0, 50) +
                                          "..."
                                        : "-"
                                    }</td>
                                </tr>
                            `
                              )
                              .join("")}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    formatTimestamp(timestamp) {
      try {
        const date = new Date(timestamp);
        return date.toLocaleString("pt-BR");
      } catch {
        return timestamp;
      }
    }

    updateLastUpdateTime(timestamp) {
      const lastUpdateEl = document.getElementById("lastUpdate");
      if (timestamp) {
        const date = new Date(timestamp);
        lastUpdateEl.textContent = `Última atualização: ${date.toLocaleString(
          "pt-BR"
        )}`;
      }
    }

    showError(message) {
      const container = document.getElementById("providersContainer");
      container.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                ${message}
            </div>
        `;
    }

    startAutoRefresh() {
      // Atualizar a cada 5 minutos
      this.refreshInterval = setInterval(() => {
        this.loadData();
      }, 5 * 60 * 1000);
    }

    stopAutoRefresh() {
      if (this.refreshInterval) {
        clearInterval(this.refreshInterval);
        this.refreshInterval = null;
      }
    }
  }

  // Inicializar dashboard
  let dashboard;
  document.addEventListener("DOMContentLoaded", function () {
    dashboard = new HealthDashboard();
  });

  // Limpar interval ao sair da página
  window.addEventListener("beforeunload", function () {
    if (dashboard) {
      dashboard.stopAutoRefresh();
    }
  });
</script>
{% endblock %}

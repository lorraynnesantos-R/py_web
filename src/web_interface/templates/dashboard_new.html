{% extends "base.html" %} {% block title %}Dashboard - {{ super() }}{% endblock
%} {% block extra_head %}
<!-- Chart.js for metrics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .metric-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: none;
    border-radius: 12px;
    overflow: hidden;
  }
  .metric-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(255, 107, 53, 0.15);
  }

  .metric-icon {
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    font-size: 1.5rem;
  }

  .timer-display {
    font-family: "Courier New", monospace;
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--color-primary);
    text-align: center;
    padding: 20px;
    background: linear-gradient(
      135deg,
      rgba(255, 107, 53, 0.1),
      rgba(255, 107, 53, 0.05)
    );
    border-radius: 12px;
    margin: 15px 0;
  }

  .status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
  }

  .status-online {
    background-color: #28a745;
  }
  .status-offline {
    background-color: #dc3545;
  }
  .status-warning {
    background-color: #ffc107;
  }

  .chart-container {
    position: relative;
    height: 300px;
    margin: 20px 0;
  }

  .log-entry {
    border-left: 3px solid var(--color-primary);
    padding: 10px 15px;
    margin: 8px 0;
    background: rgba(255, 107, 53, 0.05);
    border-radius: 0 8px 8px 0;
    transition: background-color 0.2s ease;
  }

  .log-entry:hover {
    background: rgba(255, 107, 53, 0.1);
  }

  .btn-timer {
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.2s ease;
  }

  .btn-timer:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .progress-ring {
    width: 120px;
    height: 120px;
    margin: 0 auto;
  }

  .progress-ring circle {
    stroke: var(--color-primary);
    stroke-width: 8;
    fill: transparent;
    r: 52;
    cx: 60;
    cy: 60;
    stroke-dasharray: 326.73; /* 2π × r */
    stroke-dashoffset: 326.73;
    transition: stroke-dashoffset 0.5s ease;
  }
</style>
{% endblock %} {% block content %}
<!-- Page Header -->
<div class="row mb-4">
  <div class="col">
    <h1 class="h2 mb-1">
      <i
        class="fas fa-tachometer-alt me-2"
        style="color: var(--color-primary)"
      ></i>
      Dashboard Principal
    </h1>
    <p class="text-muted mb-3">
      Visão geral do sistema de auto-upload MediocreToons
    </p>
    <div class="d-flex align-items-center">
      <span class="status-indicator status-online"></span>
      <small class="text-muted"
        >Sistema Online - <span id="last-update">Carregando...</span></small
      >
    </div>
  </div>
</div>

<!-- Main Metrics Cards -->
<div class="row mb-4">
  <!-- Total Obras -->
  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card metric-card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6
              class="text-muted mb-1 text-uppercase"
              style="font-size: 0.75rem; font-weight: 600"
            >
              Total de Obras
            </h6>
            <h2
              class="mb-1"
              style="color: var(--color-primary)"
              id="total-obras"
            >
              {{ global_stats.total_obras if global_stats else 0 }}
            </h2>
            <small class="text-success">
              <i class="fas fa-arrow-up"></i>
              <span id="obras-ativas"
                >{{ global_stats.obras_ativas if global_stats else 0 }}</span
              >
              ativas
            </small>
          </div>
          <div class="metric-icon" style="background: rgba(255, 107, 53, 0.1)">
            <i class="fas fa-book" style="color: var(--color-primary)"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quarentena -->
  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card metric-card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6
              class="text-muted mb-1 text-uppercase"
              style="font-size: 0.75rem; font-weight: 600"
            >
              Em Quarentena
            </h6>
            <h2 class="mb-1 text-warning" id="obras-quarentena">
              {{ global_stats.obras_quarentena if global_stats else 0 }}
            </h2>
            <small class="text-muted">
              <i class="fas fa-shield-alt"></i>
              Proteção ativa
            </small>
          </div>
          <div class="metric-icon" style="background: rgba(255, 193, 7, 0.1)">
            <i class="fas fa-exclamation-triangle" style="color: #ffc107"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Status da Fila -->
  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card metric-card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6
              class="text-muted mb-1 text-uppercase"
              style="font-size: 0.75rem; font-weight: 600"
            >
              Fila de Processos
            </h6>
            <h2 class="mb-1 text-info" id="queue-pending">
              {{ queue_status.pending_count if queue_status else 0 }}
            </h2>
            <small class="text-muted">
              <i class="fas fa-play-circle"></i>
              <span id="queue-processing"
                >{{ queue_status.processing_count if queue_status else 0
                }}</span
              >
              processando
            </small>
          </div>
          <div class="metric-icon" style="background: rgba(23, 162, 184, 0.1)">
            <i class="fas fa-list-ul" style="color: #17a2b8"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Último Processo -->
  <div class="col-lg-3 col-md-6 mb-4">
    <div class="card metric-card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6
              class="text-muted mb-1 text-uppercase"
              style="font-size: 0.75rem; font-weight: 600"
            >
              Último Processo
            </h6>
            <h2 class="mb-1 text-success" id="last-process-time">
              {% if recent_logs and recent_logs|length > 0 %} {{
              recent_logs[0].time.strftime('%H:%M') if recent_logs[0].time else
              '--:--' }} {% else %} --:-- {% endif %}
            </h2>
            <small class="text-muted" id="last-process-status">
              <i class="fas fa-check-circle"></i>
              {% if recent_logs and recent_logs|length > 0 %} {{
              recent_logs[0].status or 'Sucesso' }} {% else %} Aguardando {%
              endif %}
            </small>
          </div>
          <div class="metric-icon" style="background: rgba(40, 167, 69, 0.1)">
            <i class="fas fa-clock" style="color: #28a745"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Timer Control Section -->
<div class="row mb-4">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div
        class="card-header"
        style="
          background: linear-gradient(
            135deg,
            var(--color-primary),
            var(--color-primary-dark)
          );
          color: white;
        "
      >
        <h5 class="mb-0">
          <i class="fas fa-stopwatch me-2"></i>
          Controle do Timer Auto-Update
        </h5>
      </div>
      <div class="card-body">
        <div class="row align-items-center">
          <div class="col-lg-4">
            <!-- Timer Display with Progress Ring -->
            <div class="text-center">
              <div class="progress-ring" id="timer-ring">
                <svg>
                  <circle id="progress-circle"></circle>
                </svg>
              </div>
              <div class="timer-display" id="timer-display">
                {% if scheduler_status and scheduler_status.time_remaining %} {{
                scheduler_status.time_remaining }} {% else %} 00:00 {% endif %}
              </div>
              <div class="text-center">
                <span
                  class="badge"
                  id="timer-status-badge"
                  style="background: {% if scheduler_status and scheduler_status.is_running %}#28a745{% else %}#6c757d{% endif %};"
                >
                  {% if scheduler_status and scheduler_status.is_running %}
                  <i class="fas fa-play me-1"></i> Ativo {% else %}
                  <i class="fas fa-pause me-1"></i> Pausado {% endif %}
                </span>
              </div>
            </div>
          </div>

          <div class="col-lg-8">
            <!-- Timer Controls -->
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="timer-interval" class="form-label fw-bold">
                  <i class="fas fa-cog me-1"></i> Intervalo (minutos)
                </label>
                <select class="form-select" id="timer-interval">
                  <option value="15">15 minutos</option>
                  <option value="30" selected>30 minutos</option>
                  <option value="45">45 minutos</option>
                  <option value="60">1 hora</option>
                  <option value="120">2 horas</option>
                </select>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">
                  <i class="fas fa-play-circle me-1"></i> Controles
                </label>
                <div class="d-grid gap-2">
                  <div class="btn-group" role="group">
                    <button
                      type="button"
                      class="btn btn-success btn-timer"
                      id="btn-start-timer"
                    >
                      <i class="fas fa-play"></i> Start
                    </button>
                    <button
                      type="button"
                      class="btn btn-warning btn-timer"
                      id="btn-pause-timer"
                    >
                      <i class="fas fa-pause"></i> Pause
                    </button>
                    <button
                      type="button"
                      class="btn btn-danger btn-timer"
                      id="btn-stop-timer"
                    >
                      <i class="fas fa-stop"></i> Stop
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-12">
                <button
                  type="button"
                  class="btn btn-outline-primary btn-timer w-100"
                  id="btn-reset-timer"
                >
                  <i class="fas fa-redo me-2"></i> Reset Timer
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <!-- System Health -->
    <div class="card shadow-sm h-100">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fas fa-heartbeat me-2"></i>
          Saúde do Sistema
        </h6>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="small">API Status</span>
            <span class="badge bg-success">Online</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="small">Scheduler</span>
            <span class="badge bg-success">Ativo</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="small">Mapping System</span>
            <span class="badge bg-success">OK</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="small">Discord Webhook</span>
            <span class="badge bg-warning">Teste</span>
          </div>
        </div>

        <hr />

        <div class="text-center">
          <h6 class="text-muted mb-1">Uptime</h6>
          <h4 style="color: var(--color-primary)" id="system-uptime">
            02:15:30
          </h4>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Charts Section -->
<div class="row mb-4">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fas fa-chart-line me-2"></i>
          Atividade da Última Semana
        </h6>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="activityChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header">
        <h6 class="mb-0">
          <i class="fas fa-chart-pie me-2"></i>
          Taxa de Sucesso
        </h6>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas id="successChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recent Logs -->
<div class="row">
  <div class="col-12">
    <div class="card shadow-sm">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h6 class="mb-0">
          <i class="fas fa-list me-2"></i>
          Logs Recentes
        </h6>
        <button class="btn btn-sm btn-outline-primary" id="refresh-logs">
          <i class="fas fa-sync-alt"></i> Atualizar
        </button>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <div
            id="logs-container"
            style="max-height: 400px; overflow-y: auto; padding: 20px"
          >
            {% if recent_logs %} {% for log in recent_logs %}
            <div class="log-entry">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>{{ log.level or 'INFO' }}</strong>
                  <span class="text-muted ms-2"
                    >{{ log.message or 'Log message' }}</span
                  >
                </div>
                <small class="text-muted">
                  {{ log.timestamp.strftime('%H:%M:%S') if log.timestamp else
                  'timestamp' }}
                </small>
              </div>
            </div>
            {% endfor %} {% else %}
            <div class="text-center text-muted py-4">
              <i class="fas fa-file-alt fa-2x mb-3"></i>
              <p>Nenhum log recente encontrado</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div
  id="loading-overlay"
  class="d-none position-fixed w-100 h-100 top-0 start-0"
  style="background: rgba(0, 0, 0, 0.5); z-index: 9999"
>
  <div class="d-flex align-items-center justify-content-center h-100">
    <div class="text-center text-white">
      <div class="spinner-border text-primary mb-3" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
      <p>Processando...</p>
    </div>
  </div>
</div>

{% endblock %} {% block extra_scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}

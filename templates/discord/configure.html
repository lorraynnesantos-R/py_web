{% extends "base.html" %} {% block title %}Configurar Discord{% endblock %} {%
block extra_css %}
<style>
  .config-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
    border-left: 4px solid var(--primary-color);
  }

  .webhook-input {
    font-family: "Courier New", monospace;
    background-color: #f1f3f4;
  }

  .config-help {
    background: #e7f3ff;
    border: 1px solid #b3d9ff;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
  }

  .test-result {
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
  }

  .test-success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
  }

  .test-error {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
  }

  .mention-preview {
    background: #36393f;
    color: #dcddde;
    border-radius: 8px;
    padding: 15px;
    font-family: "Segoe UI", sans-serif;
  }

  .mention-highlight {
    background-color: #5865f2;
    color: white;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: bold;
  }
</style>
{% endblock %} {% block content %}
<div class="container">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-0">
            <i class="fas fa-cog text-primary"></i>
            Configurar Discord
          </h1>
          <p class="text-muted mb-0">
            Configure o sistema de notifica√ß√µes Discord
          </p>
        </div>

        <a
          href="{{ url_for('discord.index') }}"
          class="btn btn-outline-secondary"
        >
          <i class="fas fa-arrow-left"></i>
          Voltar
        </a>
      </div>
    </div>
  </div>

  <!-- Ajuda -->
  <div class="config-help">
    <h5><i class="fas fa-info-circle"></i> Como configurar</h5>
    <ol class="mb-0">
      <li>
        Crie um webhook no seu servidor Discord (Configura√ß√µes do Canal ‚Üí
        Integra√ß√µes ‚Üí Webhooks)
      </li>
      <li>Copie a URL do webhook e cole no campo abaixo</li>
      <li>Configure o ID do usu√°rio que ser√° mencionado em alertas cr√≠ticos</li>
      <li>Teste a configura√ß√£o para verificar se est√° funcionando</li>
    </ol>
  </div>

  <form id="configForm">
    <div class="row">
      <!-- Configura√ß√µes Principais -->
      <div class="col-md-8">
        <div class="config-section">
          <h5 class="mb-3">
            <i class="fab fa-discord"></i>
            Configura√ß√µes do Webhook
          </h5>

          <!-- Webhook URL -->
          <div class="mb-4">
            <label for="webhookUrl" class="form-label">
              <strong>Webhook URL</strong>
              <span class="text-danger">*</span>
            </label>
            <input
              type="url"
              class="form-control webhook-input"
              id="webhookUrl"
              value="{{ config.webhook_url }}"
              placeholder="https://discord.com/api/webhooks/123456789/abcdefgh..."
              required
            />
            <div class="form-text">
              URL do webhook criado no Discord. Mantenha esta informa√ß√£o segura!
            </div>
          </div>

          <!-- Status do Sistema -->
          <div class="mb-4">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="enabled" {{
              'checked' if config.enabled else '' }}>
              <label class="form-check-label" for="enabled">
                <strong>Habilitar Notifica√ß√µes</strong>
              </label>
            </div>
            <div class="form-text">
              Ative/desative o sistema de notifica√ß√µes globalmente
            </div>
          </div>

          <!-- Configura√ß√µes Avan√ßadas -->
          <h5 class="mb-3 mt-4">
            <i class="fas fa-sliders-h"></i>
            Configura√ß√µes Avan√ßadas
          </h5>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="rateLimitSeconds" class="form-label"
                  >Rate Limit (segundos)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="rateLimitSeconds"
                  value="{{ config.rate_limit_seconds }}"
                  min="1"
                  max="3600"
                />
                <div class="form-text">
                  Tempo m√≠nimo entre notifica√ß√µes do mesmo tipo
                </div>
              </div>
            </div>

            <div class="col-md-6">
              <div class="mb-3">
                <label for="botUsername" class="form-label">Nome do Bot</label>
                <input
                  type="text"
                  class="form-control"
                  id="botUsername"
                  value="{{ config.bot_username }}"
                />
                <div class="form-text">
                  Nome exibido nas mensagens do Discord
                </div>
              </div>
            </div>
          </div>

          <!-- Avatar URL -->
          <div class="mb-3">
            <label for="botAvatarUrl" class="form-label"
              >Avatar URL (opcional)</label
            >
            <input
              type="url"
              class="form-control"
              id="botAvatarUrl"
              value="{{ config.bot_avatar_url }}"
              placeholder="https://cdn.discordapp.com/embed/avatars/0.png"
            />
            <div class="form-text">URL da imagem para avatar do bot</div>
          </div>
        </div>

        <!-- Configura√ß√£o de Mention -->
        <div class="config-section">
          <h5 class="mb-3">
            <i class="fas fa-at"></i>
            Configura√ß√£o de Mention
          </h5>

          <div class="mb-3">
            <label for="mentionUserId" class="form-label">
              <strong>ID do Usu√°rio para Mention</strong>
              <span class="text-danger">*</span>
            </label>
            <input
              type="text"
              class="form-control"
              id="mentionUserId"
              value="{{ config.mention_user_id }}"
              required
            />
            <div class="form-text">
              ID do usu√°rio Discord que ser√° mencionado em alertas cr√≠ticos
              (como quarentena com 10+ erros)
            </div>
          </div>

          <div class="mention-preview">
            <strong>Preview do Mention:</strong><br />
            üö® <span class="mention-highlight">@Usu√°rio</span> Uma obra foi
            colocada em quarentena ap√≥s 10 erros consecutivos.
          </div>

          <div class="mt-3">
            <small class="text-muted">
              <i class="fas fa-lightbulb"></i>
              <strong>Como obter o ID:</strong> No Discord, v√° em Configura√ß√µes
              ‚Üí Avan√ßado ‚Üí Modo Desenvolvedor (ativar), depois clique com bot√£o
              direito no usu√°rio e selecione "Copiar ID".
            </small>
          </div>
        </div>
      </div>

      <!-- Sidebar de Status e Testes -->
      <div class="col-md-4">
        <!-- Status Atual -->
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="fas fa-heartbeat"></i>
              Status Atual
            </h6>
          </div>
          <div class="card-body">
            <div class="mb-2">
              <strong>Sistema:</strong>
              {% if config.enabled %}
              <span class="badge bg-success">Habilitado</span>
              {% else %}
              <span class="badge bg-secondary">Desabilitado</span>
              {% endif %}
            </div>

            <div class="mb-2">
              <strong>Webhook:</strong>
              {% if config.webhook_url %}
              <span class="badge bg-success">Configurado</span>
              {% else %}
              <span class="badge bg-warning">N√£o configurado</span>
              {% endif %}
            </div>

            <div class="mb-2">
              <strong>Mention ID:</strong>
              {% if config.mention_user_id %}
              <span class="badge bg-info">{{ config.mention_user_id }}</span>
              {% else %}
              <span class="badge bg-warning">N√£o definido</span>
              {% endif %}
            </div>

            <div>
              <strong>Rate Limit:</strong>
              <span class="badge bg-info"
                >{{ config.rate_limit_seconds }}s</span
              >
            </div>
          </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="fas fa-tools"></i>
              A√ß√µes
            </h6>
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <!-- Salvar Configura√ß√µes -->
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Salvar Configura√ß√µes
              </button>

              <!-- Testar Webhook -->
              <button
                type="button"
                class="btn btn-outline-info"
                onclick="testWebhook()"
              >
                <i class="fas fa-vial"></i>
                Testar Webhook
              </button>

              <!-- Testar Mention -->
              <button
                type="button"
                class="btn btn-outline-warning"
                onclick="testMention()"
              >
                <i class="fas fa-at"></i>
                Testar Mention
              </button>

              <!-- Reset para Padr√£o -->
              <button
                type="button"
                class="btn btn-outline-secondary"
                onclick="resetToDefault()"
              >
                <i class="fas fa-undo"></i>
                Reset Padr√£o
              </button>
            </div>
          </div>
        </div>

        <!-- Resultado dos Testes -->
        <div id="testResults" style="display: none"></div>
      </div>
    </div>
  </form>
</div>

<!-- Modal de Confirma√ß√£o Reset -->
<div class="modal fade" id="resetModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar Reset</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <p>
          Tem certeza que deseja resetar todas as configura√ß√µes para os valores
          padr√£o?
        </p>
        <p class="text-muted">Esta a√ß√£o ir√°:</p>
        <ul class="text-muted">
          <li>Limpar a URL do webhook</li>
          <li>Restaurar o ID de mention padr√£o</li>
          <li>Resetar configura√ß√µes avan√ßadas</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button type="button" class="btn btn-danger" onclick="confirmReset()">
          <i class="fas fa-undo"></i>
          Resetar
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // Salvar configura√ß√µes
  document
    .getElementById("configForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const data = {
        webhook_url: document.getElementById("webhookUrl").value.trim(),
        enabled: document.getElementById("enabled").checked,
        rate_limit_seconds: parseInt(
          document.getElementById("rateLimitSeconds").value
        ),
        mention_user_id: document.getElementById("mentionUserId").value.trim(),
        bot_username: document.getElementById("botUsername").value.trim(),
        bot_avatar_url: document.getElementById("botAvatarUrl").value.trim(),
      };

      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin"></i> Salvando...';
      submitBtn.disabled = true;

      fetch("/discord/configure", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert("Configura√ß√µes salvas com sucesso!", "success");
            // Atualizar preview do mention
            updateMentionPreview();
          } else {
            showAlert("Erro ao salvar: " + data.error, "danger");
          }
        })
        .catch((error) => {
          showAlert("Erro na requisi√ß√£o: " + error, "danger");
        })
        .finally(() => {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
    });

  // Testar webhook
  function testWebhook() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testando...';
    btn.disabled = true;

    fetch("/discord/test-webhook", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        showTestResult(data, "Teste de Webhook");
      })
      .catch((error) => {
        showTestResult(
          {
            success: false,
            error: "Erro na requisi√ß√£o: " + error,
          },
          "Teste de Webhook"
        );
      })
      .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
  }

  // Testar mention
  function testMention() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testando...';
    btn.disabled = true;

    // Enviar mensagem de teste de quarentena (que usa mention)
    const testData = {
      type: "quarantine_add",
      obra: "Obra de Teste - Mention",
      scan: "scan_teste",
      errors: 10,
      error_message: "Teste de mention para alertas cr√≠ticos",
      priority: "critical",
    };

    fetch("/discord/send-test-message", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(testData),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showTestResult(
            {
              success: true,
              message:
                "Mention testado! Verifique o Discord para ver se o usu√°rio foi mencionado.",
            },
            "Teste de Mention"
          );
        } else {
          showTestResult(data, "Teste de Mention");
        }
      })
      .catch((error) => {
        showTestResult(
          {
            success: false,
            error: "Erro na requisi√ß√£o: " + error,
          },
          "Teste de Mention"
        );
      })
      .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
  }

  // Reset para padr√£o
  function resetToDefault() {
    const modal = new bootstrap.Modal(document.getElementById("resetModal"));
    modal.show();
  }

  function confirmReset() {
    // Valores padr√£o
    document.getElementById("webhookUrl").value = "";
    document.getElementById("enabled").checked = true;
    document.getElementById("rateLimitSeconds").value = 30;
    document.getElementById("mentionUserId").value = "221057164351897610";
    document.getElementById("botUsername").value = "MediocreToons Bot";
    document.getElementById("botAvatarUrl").value =
      "https://cdn.discordapp.com/embed/avatars/0.png";

    // Fechar modal
    bootstrap.Modal.getInstance(document.getElementById("resetModal")).hide();

    showAlert(
      "Configura√ß√µes resetadas para valores padr√£o. Lembre-se de salvar!",
      "info"
    );
    updateMentionPreview();
  }

  // Mostrar resultado de teste
  function showTestResult(result, testName) {
    const resultsDiv = document.getElementById("testResults");

    const resultClass = result.success ? "test-success" : "test-error";
    const icon = result.success
      ? "fas fa-check-circle"
      : "fas fa-exclamation-circle";

    resultsDiv.innerHTML = `
        <div class="test-result ${resultClass}">
            <h6><i class="${icon}"></i> ${testName}</h6>
            <p class="mb-0">
                ${
                  result.success
                    ? result.message || "Teste realizado com sucesso!"
                    : result.error
                }
            </p>
            ${
              result.details
                ? `<small class="d-block mt-2">${result.details}</small>`
                : ""
            }
        </div>
    `;

    resultsDiv.style.display = "block";

    // Auto-esconder ap√≥s 10 segundos
    setTimeout(() => {
      resultsDiv.style.display = "none";
    }, 10000);
  }

  // Atualizar preview do mention
  function updateMentionPreview() {
    const userId = document.getElementById("mentionUserId").value.trim();
    const preview = document.querySelector(".mention-preview");

    if (userId) {
      preview.innerHTML = `
            <strong>Preview do Mention:</strong><br>
            üö® <span class="mention-highlight">@Usu√°rio</span> Uma obra foi colocada em quarentena ap√≥s 10 erros consecutivos.
            <br><small class="text-muted mt-2 d-block">ID configurado: ${userId}</small>
        `;
    }
  }

  // Valida√ß√£o em tempo real
  document.getElementById("webhookUrl").addEventListener("input", function () {
    const url = this.value.trim();
    const isValid =
      url === "" || url.startsWith("https://discord.com/api/webhooks/");

    if (url && !isValid) {
      this.classList.add("is-invalid");
      if (
        !this.nextElementSibling ||
        !this.nextElementSibling.classList.contains("invalid-feedback")
      ) {
        const feedback = document.createElement("div");
        feedback.className = "invalid-feedback";
        feedback.textContent =
          "URL deve come√ßar com https://discord.com/api/webhooks/";
        this.parentNode.appendChild(feedback);
      }
    } else {
      this.classList.remove("is-invalid");
      const feedback = this.parentNode.querySelector(".invalid-feedback");
      if (feedback) {
        feedback.remove();
      }
    }
  });

  document
    .getElementById("mentionUserId")
    .addEventListener("input", function () {
      updateMentionPreview();

      const userId = this.value.trim();
      const isValid = userId === "" || /^\d{17,19}$/.test(userId);

      if (userId && !isValid) {
        this.classList.add("is-invalid");
        if (
          !this.nextElementSibling ||
          !this.nextElementSibling.classList.contains("invalid-feedback")
        ) {
          const feedback = document.createElement("div");
          feedback.className = "invalid-feedback";
          feedback.textContent = "ID deve ter entre 17-19 d√≠gitos";
          this.parentNode.appendChild(feedback);
        }
      } else {
        this.classList.remove("is-invalid");
        const feedback = this.parentNode.querySelector(".invalid-feedback");
        if (feedback) {
          feedback.remove();
        }
      }
    });

  // Fun√ß√£o utilit√°ria para mostrar alertas
  function showAlert(message, type) {
    const alertDiv = document.createElement("div");
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText =
      "top: 20px; right: 20px; z-index: 9999; max-width: 400px;";
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    // Auto-remover ap√≥s 5 segundos
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 5000);
  }

  // Inicializar na carga da p√°gina
  document.addEventListener("DOMContentLoaded", function () {
    updateMentionPreview();
  });
</script>
{% endblock %}

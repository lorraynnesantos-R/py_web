{% extends "base.html" %} {% block title %}Discord Notifier - Testes{% endblock
%} {% block extra_css %}
<style>
  .notification-card {
    transition: all 0.3s ease;
    border-left: 4px solid var(--primary-color);
  }

  .notification-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
  }

  .stats-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
  }

  .stats-card .card-body {
    text-align: center;
  }

  .priority-critical {
    border-left-color: #dc3545 !important;
  }

  .priority-high {
    border-left-color: #ffc107 !important;
  }

  .priority-normal {
    border-left-color: #0d6efd !important;
  }

  .priority-low {
    border-left-color: #20c997 !important;
  }

  .discord-status {
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    animation: pulse 2s infinite;
  }

  .status-online {
    background-color: #28a745;
  }

  .status-offline {
    background-color: #dc3545;
  }

  .status-warning {
    background-color: #ffc107;
  }

  @keyframes pulse {
    0% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
    100% {
      opacity: 1;
    }
  }

  .test-form {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .embed-preview {
    background: #36393f;
    color: #dcddde;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    border-left: 4px solid #0099ff;
  }
</style>
{% endblock %} {% block content %}
<div class="container-fluid">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-0">
            <i class="fab fa-discord text-primary"></i>
            Discord Notifier
          </h1>
          <p class="text-muted mb-0">
            Sistema de notifica√ß√µes via Discord webhook
          </p>
        </div>

        <div class="discord-status">
          {% if stats.enabled and stats.webhook_configured and
          stats.sender_running %}
          <div class="status-indicator status-online"></div>
          <span class="badge bg-success">Sistema Ativo</span>
          {% elif not stats.enabled %}
          <div class="status-indicator status-offline"></div>
          <span class="badge bg-secondary">Desabilitado</span>
          {% elif not stats.webhook_configured %}
          <div class="status-indicator status-warning"></div>
          <span class="badge bg-warning">Webhook n√£o configurado</span>
          {% else %}
          <div class="status-indicator status-offline"></div>
          <span class="badge bg-danger">Sender parado</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Estat√≠sticas -->
  <div class="row mb-4">
    <div class="col-md-2">
      <div class="card stats-card">
        <div class="card-body">
          <h5 class="card-title">üì§ Enviadas</h5>
          <h2 class="mb-0">{{ stats.sent_count }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card stats-card">
        <div class="card-body">
          <h5 class="card-title">‚ùå Falharam</h5>
          <h2 class="mb-0">{{ stats.failed_count }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card stats-card">
        <div class="card-body">
          <h5 class="card-title">‚è±Ô∏è Rate Limited</h5>
          <h2 class="mb-0">{{ stats.rate_limited_count }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card stats-card">
        <div class="card-body">
          <h5 class="card-title">‚úÖ Taxa Sucesso</h5>
          <h2 class="mb-0">{{ "%.1f"|format(stats.success_rate * 100) }}%</h2>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card stats-card">
        <div class="card-body">
          <h5 class="card-title">üìã Fila</h5>
          <h2 class="mb-0">{{ stats.queue_size }}</h2>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card stats-card">
        <div class="card-body">
          <h5 class="card-title">üîß Webhook</h5>
          <h2 class="mb-0">
            {% if stats.webhook_configured %}
            <i class="fas fa-check text-success"></i>
            {% else %}
            <i class="fas fa-times text-danger"></i>
            {% endif %}
          </h2>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Controles -->
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-cogs"></i>
            Controles do Sistema
          </h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <!-- Teste de Webhook -->
            <button class="btn btn-outline-primary" onclick="testWebhook()">
              <i class="fas fa-vial"></i>
              Testar Webhook
            </button>

            <!-- Controle do Sender -->
            {% if stats.sender_running %}
            <button class="btn btn-outline-danger" onclick="stopSender()">
              <i class="fas fa-stop"></i>
              Parar Sender
            </button>
            {% else %}
            <button class="btn btn-outline-success" onclick="startSender()">
              <i class="fas fa-play"></i>
              Iniciar Sender
            </button>
            {% endif %}

            <!-- Limpar Fila -->
            <button class="btn btn-outline-warning" onclick="clearQueue()">
              <i class="fas fa-trash"></i>
              Limpar Fila ({{ stats.queue_size }})
            </button>

            <!-- Reset Estat√≠sticas -->
            <button
              class="btn btn-outline-secondary"
              onclick="resetStatistics()"
            >
              <i class="fas fa-redo"></i>
              Reset Estat√≠sticas
            </button>

            <!-- Configura√ß√µes -->
            <a
              href="{{ url_for('discord.configure') }}"
              class="btn btn-outline-info"
            >
              <i class="fas fa-cog"></i>
              Configura√ß√µes
            </a>
          </div>
        </div>
      </div>

      <!-- √öltimas Notifica√ß√µes -->
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-history"></i>
            √öltimas Notifica√ß√µes
          </h5>
        </div>
        <div class="card-body">
          {% if stats.last_notifications %} {% for notification_type, timestamp
          in stats.last_notifications.items() %}
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span>
              {{ notification_type|notification_type_icon }} {{
              notification_type.replace('_', ' ').title() }}
            </span>
            <small class="text-muted">
              {{ moment(timestamp).fromNow() }}
            </small>
          </div>
          {% endfor %} {% else %}
          <p class="text-muted mb-0">Nenhuma notifica√ß√£o enviada ainda</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Formul√°rio de Teste -->
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-paper-plane"></i>
            Enviar Mensagem de Teste
          </h5>
        </div>
        <div class="card-body">
          <form id="testMessageForm">
            <!-- Tipo de Mensagem -->
            <div class="mb-3">
              <label for="messageType" class="form-label"
                >Tipo de Mensagem</label
              >
              <select
                class="form-select"
                id="messageType"
                onchange="updateMessageForm()"
              >
                <option value="custom">Mensagem Personalizada</option>
                <option value="quarantine_add">Obra em Quarentena</option>
                <option value="quarantine_remove">Obra Reativada</option>
                <option value="daily_summary">Resumo Di√°rio</option>
                <option value="system_error">Erro do Sistema</option>
                <option value="system_status">Status do Sistema</option>
              </select>
            </div>

            <!-- Prioridade -->
            <div class="mb-3">
              <label for="priority" class="form-label">Prioridade</label>
              <select class="form-select" id="priority">
                <option value="low">Baixa</option>
                <option value="normal" selected>Normal</option>
                <option value="high">Alta</option>
                <option value="critical">Cr√≠tica (com mention)</option>
              </select>
            </div>

            <!-- Campos Din√¢micos -->
            <div id="dynamicFields">
              <!-- Campos padr√£o para mensagem personalizada -->
              <div class="mb-3">
                <label for="content" class="form-label"
                  >Conte√∫do da Mensagem</label
                >
                <textarea
                  class="form-control"
                  id="content"
                  rows="3"
                  placeholder="Digite sua mensagem aqui..."
                ></textarea>
              </div>

              <!-- Embed personalizado -->
              <div class="mb-3">
                <label class="form-label">Embed Opcional</label>
                <div class="row">
                  <div class="col-md-6">
                    <input
                      type="text"
                      class="form-control mb-2"
                      id="embedTitle"
                      placeholder="T√≠tulo do embed"
                    />
                  </div>
                  <div class="col-md-6">
                    <input
                      type="color"
                      class="form-control"
                      id="embedColor"
                      value="#0099ff"
                      title="Cor do embed"
                    />
                  </div>
                </div>
                <textarea
                  class="form-control"
                  id="embedDescription"
                  rows="2"
                  placeholder="Descri√ß√£o do embed"
                ></textarea>
              </div>
            </div>

            <!-- Bot√£o Enviar -->
            <div class="d-grid">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-paper-plane"></i>
                Enviar Mensagem de Teste
              </button>
            </div>
          </form>

          <!-- Preview do Embed -->
          <div id="embedPreview" class="embed-preview" style="display: none">
            <div
              class="embed-title"
              style="font-weight: bold; margin-bottom: 8px"
            ></div>
            <div class="embed-description"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Configura√ß√£o R√°pida -->
<div class="modal fade" id="quickConfigModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Configura√ß√£o R√°pida</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="quickConfigForm">
          <div class="mb-3">
            <label for="webhookUrl" class="form-label">Webhook URL</label>
            <input
              type="url"
              class="form-control"
              id="webhookUrl"
              placeholder="https://discord.com/api/webhooks/..."
            />
          </div>
          <div class="mb-3">
            <label for="mentionUserId" class="form-label"
              >ID do Usu√°rio para Mention</label
            >
            <input
              type="text"
              class="form-control"
              id="mentionUserId"
              value="{{ stats.mention_user_id or '221057164351897610' }}"
            />
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox"
            id="enableNotifications" {{ 'checked' if stats.enabled else '' }}>
            <label class="form-check-label" for="enableNotifications">
              Habilitar Notifica√ß√µes
            </label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="saveQuickConfig()"
        >
          Salvar
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // Atualizar estat√≠sticas a cada 30 segundos
  setInterval(function () {
    fetch("/discord/statistics")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          location.reload(); // Simples reload para atualizar stats
        }
      })
      .catch(console.error);
  }, 30000);

  // Testar webhook
  function testWebhook() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testando...';
    btn.disabled = true;

    fetch("/discord/test-webhook", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showAlert("Webhook testado com sucesso!", "success");
        } else {
          showAlert("Erro no teste: " + data.error, "danger");
        }
      })
      .catch((error) => {
        showAlert("Erro na requisi√ß√£o: " + error, "danger");
      })
      .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
  }

  // Iniciar sender
  function startSender() {
    fetch("/discord/start-sender", { method: "POST" })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showAlert(data.message, "success");
          setTimeout(() => location.reload(), 1000);
        } else {
          showAlert(data.error, "warning");
        }
      })
      .catch((error) => showAlert("Erro: " + error, "danger"));
  }

  // Parar sender
  function stopSender() {
    fetch("/discord/stop-sender", { method: "POST" })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showAlert(data.message, "success");
          setTimeout(() => location.reload(), 1000);
        } else {
          showAlert(data.error, "warning");
        }
      })
      .catch((error) => showAlert("Erro: " + error, "danger"));
  }

  // Limpar fila
  function clearQueue() {
    if (confirm("Tem certeza que deseja limpar a fila de notifica√ß√µes?")) {
      fetch("/discord/clear-queue", { method: "POST" })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert(data.message, "success");
            setTimeout(() => location.reload(), 1000);
          } else {
            showAlert(data.error, "danger");
          }
        })
        .catch((error) => showAlert("Erro: " + error, "danger"));
    }
  }

  // Reset estat√≠sticas
  function resetStatistics() {
    if (confirm("Tem certeza que deseja resetar todas as estat√≠sticas?")) {
      fetch("/discord/reset-statistics", { method: "POST" })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert(data.message, "success");
            setTimeout(() => location.reload(), 1000);
          } else {
            showAlert(data.error, "danger");
          }
        })
        .catch((error) => showAlert("Erro: " + error, "danger"));
    }
  }

  // Atualizar formul√°rio baseado no tipo
  function updateMessageForm() {
    const messageType = document.getElementById("messageType").value;
    const dynamicFields = document.getElementById("dynamicFields");

    // Templates para diferentes tipos
    const templates = {
      custom: `
            <div class="mb-3">
                <label for="content" class="form-label">Conte√∫do da Mensagem</label>
                <textarea class="form-control" id="content" rows="3" 
                          placeholder="Digite sua mensagem aqui..."></textarea>
            </div>
            <div class="mb-3">
                <label class="form-label">Embed Opcional</label>
                <div class="row">
                    <div class="col-md-6">
                        <input type="text" class="form-control mb-2" id="embedTitle" 
                               placeholder="T√≠tulo do embed">
                    </div>
                    <div class="col-md-6">
                        <input type="color" class="form-control" id="embedColor" 
                               value="#0099ff" title="Cor do embed">
                    </div>
                </div>
                <textarea class="form-control" id="embedDescription" rows="2" 
                          placeholder="Descri√ß√£o do embed"></textarea>
            </div>
        `,
      quarantine_add: `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="obra" class="form-label">Nome da Obra</label>
                        <input type="text" class="form-control" id="obra" value="Attack on Titan">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="scan" class="form-label">Nome do Scan</label>
                        <input type="text" class="form-control" id="scan" value="mangahost">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="errors" class="form-label">N√∫mero de Erros</label>
                        <input type="number" class="form-control" id="errors" value="10" min="1">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="errorMessage" class="form-label">√öltimo Erro</label>
                        <input type="text" class="form-control" id="errorMessage" 
                               value="Connection timeout ap√≥s 30s">
                    </div>
                </div>
            </div>
        `,
      quarantine_remove: `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="obra" class="form-label">Nome da Obra</label>
                        <input type="text" class="form-control" id="obra" value="One Piece">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="scan" class="form-label">Nome do Scan</label>
                        <input type="text" class="form-control" id="scan" value="scan1">
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label for="reason" class="form-label">Motivo da Reativa√ß√£o</label>
                <input type="text" class="form-control" id="reason" 
                       value="Site voltou ao ar - problema resolvido">
            </div>
        `,
      daily_summary: `
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="totalUploads" class="form-label">Total Uploads</label>
                        <input type="number" class="form-control" id="totalUploads" value="50">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="successRate" class="form-label">Taxa Sucesso (%)</label>
                        <input type="number" class="form-control" id="successRate" 
                               value="85" min="0" max="100" step="0.1">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="quarantineCount" class="form-label">Em Quarentena</label>
                        <input type="number" class="form-control" id="quarantineCount" value="3">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="newQuarantines" class="form-label">Novas Quarentenas</label>
                        <input type="number" class="form-control" id="newQuarantines" value="1">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="reactivated" class="form-label">Reativadas</label>
                        <input type="number" class="form-control" id="reactivated" value="2">
                    </div>
                </div>
            </div>
        `,
      system_error: `
            <div class="mb-3">
                <label for="component" class="form-label">Componente</label>
                <input type="text" class="form-control" id="component" value="AutoUpdateScheduler">
            </div>
            <div class="mb-3">
                <label for="errorMessage" class="form-label">Mensagem de Erro</label>
                <textarea class="form-control" id="errorMessage" rows="2">
Falha na conex√£o com a API ap√≥s 3 tentativas</textarea>
            </div>
            <div class="mb-3">
                <label for="details" class="form-label">Detalhes (JSON)</label>
                <textarea class="form-control" id="details" rows="3">
{
    "attempts": 3,
    "last_error": "Connection timeout",
    "next_retry": "15 minutes"
}</textarea>
            </div>
        `,
      system_status: `
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-control" id="status">
                            <option value="online">Online</option>
                            <option value="offline">Offline</option>
                            <option value="maintenance">Manuten√ß√£o</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="activeJobs" class="form-label">Jobs Ativos</label>
                        <input type="number" class="form-control" id="activeJobs" value="3">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="queueSize" class="form-label">Tamanho da Fila</label>
                        <input type="number" class="form-control" id="queueSize" value="12">
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label for="uptime" class="form-label">Uptime</label>
                <input type="text" class="form-control" id="uptime" value="2 days 14 hours">
            </div>
        `,
    };

    dynamicFields.innerHTML = templates[messageType] || templates["custom"];

    // Adicionar listeners para preview do embed
    if (messageType === "custom") {
      addEmbedPreviewListeners();
    }
  }

  // Preview do embed para mensagem personalizada
  function addEmbedPreviewListeners() {
    const titleInput = document.getElementById("embedTitle");
    const descInput = document.getElementById("embedDescription");
    const colorInput = document.getElementById("embedColor");
    const preview = document.getElementById("embedPreview");

    function updatePreview() {
      const title = titleInput.value.trim();
      const description = descInput.value.trim();
      const color = colorInput.value;

      if (title || description) {
        preview.style.display = "block";
        preview.style.borderLeftColor = color;

        preview.querySelector(".embed-title").textContent = title;
        preview.querySelector(".embed-description").textContent = description;
      } else {
        preview.style.display = "none";
      }
    }

    [titleInput, descInput, colorInput].forEach((input) => {
      input.addEventListener("input", updatePreview);
    });
  }

  // Enviar mensagem de teste
  document
    .getElementById("testMessageForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const messageType = document.getElementById("messageType").value;
      const priority = document.getElementById("priority").value;

      // Coletar dados baseado no tipo
      const data = {
        type: messageType,
        priority: priority,
      };

      // Coletar campos espec√≠ficos
      const inputs = this.querySelectorAll("input, textarea, select");
      inputs.forEach((input) => {
        if (input.id && input.id !== "messageType" && input.id !== "priority") {
          let value = input.value.trim();

          // Converter valores especiais
          if (input.type === "number") {
            value = parseFloat(value) || 0;
          } else if (input.id === "details" && value) {
            try {
              value = JSON.parse(value);
            } catch (e) {
              value = { error: "JSON inv√°lido" };
            }
          } else if (input.id === "successRate") {
            value = parseFloat(value) / 100 || 0;
          }

          data[input.id] = value;
        }
      });

      // Enviar
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML =
        '<i class="fas fa-spinner fa-spin"></i> Enviando...';
      submitBtn.disabled = true;

      fetch("/discord/send-test-message", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showAlert("Mensagem enviada com sucesso!", "success");
          } else {
            showAlert("Erro ao enviar: " + data.error, "danger");
          }
        })
        .catch((error) => {
          showAlert("Erro na requisi√ß√£o: " + error, "danger");
        })
        .finally(() => {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        });
    });

  // Configura√ß√£o r√°pida
  function saveQuickConfig() {
    const data = {
      webhook_url: document.getElementById("webhookUrl").value.trim(),
      mention_user_id: document.getElementById("mentionUserId").value.trim(),
      enabled: document.getElementById("enableNotifications").checked,
    };

    fetch("/discord/configure", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showAlert("Configura√ß√µes salvas!", "success");
          bootstrap.Modal.getInstance(
            document.getElementById("quickConfigModal")
          ).hide();
          setTimeout(() => location.reload(), 1000);
        } else {
          showAlert("Erro ao salvar: " + data.error, "danger");
        }
      })
      .catch((error) => showAlert("Erro: " + error, "danger"));
  }

  // Fun√ß√£o utilit√°ria para mostrar alertas
  function showAlert(message, type) {
    const alertDiv = document.createElement("div");
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText =
      "top: 20px; right: 20px; z-index: 9999; max-width: 400px;";
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(alertDiv);

    // Auto-remover ap√≥s 5 segundos
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 5000);
  }

  // Inicializar na carga da p√°gina
  document.addEventListener("DOMContentLoaded", function () {
    // Atualizar form inicial
    updateMessageForm();
  });
</script>
{% endblock %}
